# Setting Up Jenkins Pipelines

This document provides a step-by-step guide on how to set up Jenkins pipelines for continuous integration and continuous deployment (CI/CD) in the Helabooking infrastructure project.

## Important Points

- Jenkins is deployed into the `management` namespace using Helm charts.
- Agents pods are created dynamically in the `galaxy-node` (for x86 architecture) when a pipeline job is triggered.
  > (There's an issue where the agent pods doesn't run as root user even after setting `runAsUser: 0` in the Helm values file. Till this is fixed, manually set `runAsUser: 0` and `runAsGroup: 0` in the pod security context of the agent pod template in Jenkins UI (https://jenkins.management.ezbooking.lk/manage/cloud/kubernetes/templates) if already not done.)
- Pipelines are defined using Jenkinsfiles stored in `/on-prem/jenkins-jobs/` and `/cloud/jenkins-jobs/` directory of the repository.
- Pipelines will be created as Multibranch Pipeline jobs using the files in the above directories using below steps.
- Basic credentials can be stored in a `secrets.tf` file in the respective environment directories.
  (Refer to the existing `secrets.tf` files for the required structure and values.)
- Additional secrets files (`kube-config.yaml`, `secrets.tf`, etc.) are stored in the `group9-secrets-bucket` S3 bucket followed by `/on-prem/` or `/cloud/` directory paths.
  (Refer to existing jenkins jobs for how to use these secrets files in the pipelines.)
- Required plugins are installed using the Helm chart values file during Jenkins deployment.
- Configured pipelines confgs are stored in persistent storage attached to the Jenkins server.
- Currently different tools like Terraform, kubectl, AWS CLI are installed in the Agents pods at runtime. Will be using a custom Docker image for the agents in the future to speed up the pipeline execution.

## Project Pipelines

| Pipeline Name      | Jenkinsfile Path                                       | Type        | Status   | Description                                                                           |
| ------------------ | ------------------------------------------------------ | ----------- | -------- | ------------------------------------------------------------------------------------- |
| terraform-deploy   | `/on-prem/jenkins-jobs/terraform-deploy.Jenkinsfile`   | Multibranch | Deployed | Deploys infrastructure using Terraform for on-prem cluster with manual approval step. |
| docker-image-build | `/on-prem/jenkins-jobs/docker-image-build.Jenkinsfile` | Pending     | Pending  | Builds and pushes Docker images to on-prem Harbor registry.                           |

## Steps to Create Multibranch Pipeline Jobs

1. **Setup ENV Variables and Credentials**:

   - Declare necessary environment variables and credentials in the `variables.tf` and `secrets.tf` files in the respective environment directories. (Refer to existing files for structure and values.)
   - Add them to the `jenkins_helm` module in the `on-prem/management/deployments.tf` file as Helm values under `Config as Code (JCasC) scripts` section.
   - Apply the Terraform configuration manually or upload the updated `secrets.tf` file to the `group9-secrets-bucket` S3 bucket and commit the changes to the repository to redeploy Jenkins with the updated configurations.
   - Reload the Jenkins configuration from the UI (https://jenkins.management.ezbooking.lk/configuration-as-code/reload).

2. **Create a New Pipeline Job**:

   - In Jenkins, click on "New Item".
   - Enter a name for the job (e.g., `my-multibranch-pipeline`).
   - Select "Multibranch Pipeline" and click "OK".

3. **Configure Branch Sources**:

   - Fill the basic information (Display Name, Description).
   - In the job configuration, scroll down to the "Branch Sources" section.
   - Click on "Add Source" and select "Git".
   - Enter the repository URL (e.g., `https://github.com/my-org/my-repo.git`).
   - Add any necessary credentials for accessing the repository. (Already setup for the Helabooking repo using Helm values as Jenkins Credentials.)
   - Optionally, you can configure additional behaviors like filtering branches.

4. **Define Jenkinsfile Path**:

   - In the "Build Configuration" section, select "by Jenkinsfile".
   - Specify the path to the `Jenkinsfile` if it's not in the root directory. (e.g., `on-prem/jenkins-jobs/terraform-deploy.Jenkinsfile`).
   - In the "Scan Multibranch Pipeline Triggers" section, you can define how often Jenkins should check for new branches. (Recommend: 5 minutes)
   - By default, Jenkins looks for a `Jenkinsfile` in the root of each branch. If your `Jenkinsfile` is located in a subdirectory, you can specify the path (e.g., `on-prem/jenkins-jobs/`).

5. **Save the Job**:

   - Click "Save" to create the job.
   - Jenkins will automatically scan the repository for branches and create corresponding pipeline jobs.

6. **Trigger a Build**:

   - You can manually trigger a build for any branch by navigating to the branch's job page and clicking "Build Now".

7. **Create Git Webhook (Optional)**:
   - To automate the triggering of builds on code changes, set up a webhook in the Git repository to notify Jenkins of new commits or pull requests.
   - In the Git repository settings --> Webhooks, add a webhook pointing to `https://jenkins.management.ezbooking.lk/generic-webhook-trigger/invoke` as `application/json` type.
   - Configure the webhook to trigger on push events and pull request events.
8. **Test and Iterate**:
   - Test the pipeline by pushing changes to the repository or creating pull requests.
   - Monitor the builds in Jenkins and iterate on the `Jenkinsfile` as needed to refine the pipeline process.

> Once the pipelines are set up as required, remember to upload the updated `secrets.tf` files to the S3 bucket and to Google Drive shared folder for sharing with the team.
> If there's any important points, updates the documentation accordingly.
