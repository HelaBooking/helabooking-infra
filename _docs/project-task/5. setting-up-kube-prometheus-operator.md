# Setting Up Kube-Prometheus-Operator - For the Each Environment

This guide provides step-by-step instructions on how to set up the Kube-Prometheus-Operator for monitoring Kubernetes clusters in different environments (development, staging, production).

## Important Points

- Kube-Prometheus-Operator with Grafana will be deployed into each environment's dedicated namespace (e.g., `env-dev`, `env-staging`, `env-prod`).
- This is deployed using Helm charts managed via Terraform.
- Each environment will have its own set of monitoring configurations and alerting rules.
- In the configs, there are ports renamed. This is required for Istio compliance.

## Steps to Set Up Kube-Prometheus-Operator

1. **Create Kube-Prometheus-Operator Deployment using Terraform**:
   - Switch to the respective environment branch in the `helabooking-infra` repository.
   - Create a new Terraform module in the `deployments.tf` file in the respective environment folder (e.g., `env-dev`, `env-staging`, etc.) under the correct kubernetes cluster.
   - Define the Kube-Prometheus-Operator Helm chart parameters such as release name, chart version, namespace, and values overrides. (Example can be found in `on-prem/env-dev/deployments.tf`)
   - Further customize the values for Grafana and Prometheus as in the `variables.tf` file in the same environment folder.
   - Update the `secrets.tf` file in the respective environment folder to include any necessary credentials for Grafana (e.g., admin password).
   - Add the `monitoring` label to the namespaces with the value defined in the Prometheus Scrape Selectors in the `variables.tf` file. This is to ensure that Prometheus scrapes metrics from the namespaces.
2. **Upload Secrets to S3**:
   - After updating the `secrets.tf` files in each environment, upload the secrets to the `group9-secrets-bucket`'s respective folder.
3. **Create DNS Records**:
   - Open the `dns-records.tf` file in the respective environment folder (e.g., `on-prem/env-dev`, `cloud/env-stag`, etc.).
   - Add DNS records for Grafana by referring to existing records.
   - Commit the changes into relevant environment branch to deploy automatically via Terraform.
4. **Access Grafana UI**:
   - Open your web browser and navigate to the Grafana UI at `http://grafana.<environment>.ezbooking.lk` (replace `<environment>` with `dev`, `staging`, or `prod`).
   - Log in using the admin credentials stored in the environment's `secrets.tf` file
5. **Verify Deployment**:
   - In the Grafana UI, navigate to the Data Sources section.
   - Ensure that Prometheus is listed as a data source and is functioning correctly.
   - Head to the Dashboards section and verify that the default dashboards are available and displaying data.
6. **Configure Alerting Rules**:
   - Navigate to the Alerting section in Grafana. Many default alerting rules are pre-configured.
   - Customize or add new alerting rules as per the environment's requirements.
