# Setting up OpenSearch with Fluent Bit For Log Management - For the Each Environment

This document provides a step-by-step guide on how to set up OpenSearch with Fluent Bit for log management in the Helabooking infrastructure project.

## Important Points

- OpenSearch clusters and OpenSearch Dashboards are deployed in each environment (dev, qa, stag, prod) namespace using Helm charts. `mangement` namespace also direct traffic to either `dev` or `stag` environment of each on-prem and cloud k8s clusters.
- Fluent Bit is used as the log forwarder to collect logs from pods and send them to OpenSearch. It is deployed using Helm charts in the `management` namespace.
- Logs are indexed in OpenSearch with different indices for each namespace.
- In the configs, there are ports renamed. This is required for Istio compliance.

## Steps to Set Up OpenSearch with Fluent Bit

1. **Deploy OpenSearch and OpenSearch Dashboards using Helm**:
   - Refer the exsisting Helm chart configurations in the `on-prem/env-dev/deployments.tf` when creating new environment.
   - Ensure to set the necessary parameters (cluster name, namespace, resource limits, storage class, etc.) in the Helm values.
   - Commit the changes into relevant environment branch to deploy automatically via Terraform.
2. **Deploy Fluent Bit using Helm**:
   - Switch to the `on-prem-mangement` or `cloud-mangement` branch first. Then create a new Helm release for Fluent Bit in the `management/deployments.tf` file.
   - Configure Fluent Bit to collect logs from required namespaces and forward them to the OpenSearch cluster. (Refer the configurations in the `on-prem/management/variables.tf` for necessary fluent bit configs such as service, input, and filters)
3. **Configure Fluent Bit to Send Logs to OpenSearch**:
   - In the Fluent Bit Helm values, set up the output configuration to point to the OpenSearch cluster endpoint. (Refer `on-prem/management/secrets.tf` for sample configurations)
4. **Upload Secrets to S3**:
   - After updating the `secrets.tf` files in each environment, upload the secrets to the `group9-secrets-bucket`'s respective folder.
5. **Create DNS Records**:
   - Open the `dns-records.tf` file in the respective environment folder (e.g., `on-prem/env-dev`, `cloud/env-stag`, etc.).
   - Add DNS records for OpenSearch Dashboards by referiring to exsisting records.
   - Commit the changes into relevant environment branch to deploy automatically via Terraform.
6. **Access OpenSearch Dashboards**:
   - Open your web browser and navigate to the OpenSearch Dashboards UI at `https://opensearch.<namespace>.ezbooking.lk` for each environment.
   - Log in using the admin credentials stored in the environment's `secrets.tf` file
7. **Create Index Patterns**:
   - In the OpenSearch Dashboards UI, navigate to the "Index Patterns" section.
   - Create index patterns for each namespace to visualize logs. For example, create an index pattern like `logs-dev-*` for the dev environment.
8. **Verify Log Ingestion**:
   - In the OpenSearch Dashboards UI, navigate to the "Discover" section.
   - Select the appropriate index pattern and verify that logs from the configured namespaces are being ingested and displayed correctly.
9. **Set Up Alerts and Visualizations**:
   - Use OpenSearch Dashboards to create visualizations and dashboards for log data.
   - Set up alerts based on specific log patterns or thresholds as needed.
