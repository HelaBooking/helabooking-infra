# Environment Setup - Node Setup

This document outlines the steps to set up local nodes for a Kubernetes cluster using k3s on two devices: a Raspberry Pi 5 and an old Samsung laptop. Additionally, it covers the setup of Terraform on a local machine to manage the Kubernetes cluster.

## Local Node Setup

Setps related to setting up local nodes for kubernetes clusters. Here are the local environment specifications:

- Raspberry Pi 5 (8GB RAM)
  - OS: Ubuntu 24.04.2 LTS
  - CPU: ARM Cortex-A76 (4 cores @ 2.4GHz)
  - Storage: 240GB NVME
  - Network: Gigabit Ethernet (1Gbps)
- Samsung Old Laptop
  - OS: Ubuntu 24.04.2 LTS
  - CPU: Intel Core 3-3120M (2 cores @ 2.5GHz)
  - RAM: 6GB DDR3
  - Storage: 240GB SSD
  - Network: Ethernet (100Mbps)

### Common Steps for both devices:

1.  Install Ubuntu 24.04.2 LTS on both devices.
2.  Setup static IP addresses for both devices.
3.  Install docker and its components (https://docs.docker.com/engine/install/ubuntu/).
4.  Enable Swap (OS Level):
    - Create a 4GB swap file (adjust size if needed):
      `sudo fallocate -l 4G /swapfile`
      `sudo chmod 600 /swapfile`
      `sudo mkswap /swapfile`
      `sudo swapon /swapfile`
    - Make persistent:
      `echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab`
    - Set low swappiness (10) to reduce I/O wear:
      `sudo sysctl vm.swappiness=10`
      `echo 'vm.swappiness=10' | sudo tee /etc/sysctl.d/99-k3s-swap.conf`
5.  Create a directory to store persistent data for longhorn:
    - `sudo mkdir /longhorn`
6.  Install k3s based on the following guide: https://docs.k3s.io/quick-start
    - For Raspberry Pi:
      - `curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--disable traefik" sh -`
      - Note down the K3S_TOKEN from `/var/lib/rancher/k3s/server/node-token` and the IP address of the Raspberry Pi.
    - For Samsung Laptop:
      - `curl -sfL https://get.k3s.io | K3S_URL=https://myserver:6443 K3S_TOKEN=mynodetoken sh -`
7.  Configure NodeSwap Feature (Post-Install):

    - Create or edit the config file on both nodes: `sudo nano /etc/rancher/k3s/config.yaml`
    - Paste the following YAML configuration:

          # Enable Kubelet swap features
          kubelet-arg:
            - "feature-gates=NodeSwap=true"
          # Enable API Server validation of swap
          kube-apiserver-arg:
            - "feature-gates=NodeSwap=true"

    - Restart the service to apply changes:
      - Raspberry Pi: `sudo systemctl restart k3s`
      - Samsung Laptop: `sudo systemctl restart k3s-agent`

## Terraform & Kubectl Setup

1. Install Terraform on local machine (WSL). Enable command auto-complete. (https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli).
2. Setup alias for terraform commands.
   - `alias tf='terraform'`
3. Download the kubeconfig file (`/etc/rancher/k3s/k3s.yaml`) given to the local machine: (also copy the config to Terraform folder as: `/on-prem/cluster-config/kube-config.yaml`)
   - Copy the content and save it as `~/.kube/config` on the local machine (WSL).
4. Install kubectl on local machine. (https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/).
5. Configure alias and auto-complete for kubectl (https://stackoverflow.com/questions/52905811/kubernetes-kubectl-bash-completion-with-alias).
6. Verify kubectl access:
   - `k get nodes`

### Remote State Management

> Prerequisite: AWS CLI configured with appropriate permissions (Recommend WSL).

- Install AWS CLI: https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html

      - `curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"`
      - `unzip awscliv2.zip`
      - `sudo ./aws/install`
      - Verify installation: `aws --version`

- Generate a Temporary AWS Access Key and Secret Key with permissions under MFA. (First need to setup MFA for the AWS account)
  - Get the ARN for the MFA device from the AWS Management Console (Account Name --> Security Credentials --> Multi-Factor Authentication (MFA) --> Identifier).
  - Use the following command to generate temporary credentials:
    `aws sts get-session-token --serial-number <arn-mfa-device> \ --token-code <2fa-code>`
  - Note down the `AccessKeyId`, `SecretAccessKey`, and `SessionToken` from the output.
- Run the following commands to set the environment variables (replace the placeholders with actual values):
  export AWS_REGION=ap-southeast-1
  export AWS_ACCESS_KEY_ID=<access-key-id-from-output>
  export AWS_SECRET_ACCESS_KEY=<secret-access-key-from-output>
  export AWS_SESSION_TOKEN=<session-token-from-output>

#### Steps (Already Performed):

1. Setup an S3 bucket for Terraform remote state storage.
   - Create an S3 bucket using the AWS Management Console or AWS CLI.
     `aws s3api create-bucket --bucket group9-terraform-state-bucket --region ap-southeast-1 --create-bucket-configuration LocationConstraint=ap-southeast-1`
   - Enable versioning on the S3 bucket:
     `aws s3api put-bucket-versioning --bucket group9-terraform-state-bucket --versioning-configuration Status=Enabled`
   - Enable server-side encryption on the S3 bucket:
     `aws s3api put-bucket-encryption --bucket group9-terraform-state-bucket --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'`
2. Configure the backends in Terraform files (state file per env) to use the S3 bucket.
   ```hcl
   terraform {
     backend "s3" {
       bucket         = "group9-terraform-state-bucket"
       key            = "/on-prem/<env-name>-terraform.tfstate"
       region         = "ap-southeast-1"
       use_lockfile = true
       encrypt        = true
     }
   }
   ```
3. CD into each environment directory and initialize Terraform with the new backend:
   - `tf init`
4. Verify remote state configuration:
   - `tf state list`
