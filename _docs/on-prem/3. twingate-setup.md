# Twingate Setup

This document outlines the steps to set up Twingate for secure remote access to the cluster KubeApi server and other internal services.

## Prerequisites

- A Twingate account with administrative privileges.
- A Twingate Network already created for the organization.

## Step 1: Setup Twingate Access

1. Log in to your Twingate Admin Console and create a new Connector. Note down the connector `Access Token` and `Refresh Token`.
2. Create a `.env` file in the master node of the cluster inside a directory of your choice (e.g., `/opt/twingate/`). Add the following environment variables.

   ```bash
   mkdir -p /opt/twingate
   nano /opt/twingate/.env

    TWINGATE_NETWORK=<Your_Twingate_Network_Name>
    TWINGATE_ACCESS_TOKEN=<Your_Access_Token_Here>
    TWINGATE_REFRESH_TOKEN=<Your_Refresh_Token_Here>
    TWINGATE_LABEL_HOSTNAME=<Your_Desired_Hostname>
    TWINGATE_LOG_ANALYTICS=v2
    TWINGATE_LABEL=<Your_Connector_Label>
    TWINGATE_LABEL_DEPLOYED_BY=docker-compose
   ```

3. Create a `docker-compose.yml` file in the same directory with the following content:

   ```yaml
   services:
     twingate-connector:
       image: twingate/connector:1
       container_name: twingate-connector
       restart: unless-stopped
       network_mode: host
       env_file: .env
       pull_policy: always
       logging:
         driver: "json-file"
         options:
           max-size: "10m"
           max-file: "7"
   ```

4. Start the Twingate Connector using Docker Compose `docker-compose up -d` and verify that it picked by the Twingate Admin Console.
5. Add new Resource in the Twingate Admin Console as follows: (Add KubeAPI and NGNIX Proxy ports)

   - Name: `K3s-cluster`
   - IP: `<Cluster_Master_Node_IP>`
   - Port Restrictions:
     - TCP: Custom Ports: `6443,81`
     - UDP: Blocked
     - ICMP: Block

6. Next, create an Access Group and assign the `K3s-cluster` Resource to it.

## Step 2: Access Using Twingate

1. Install the Twingate Client on your local machine from the [Twingate Downloads Page](https://www.twingate.com/downloads/).
   (Note: For WSL, use the Windows Twingate Client. It can route traffic to WSL instances.)
2. Log in to the Twingate Client using your Twingate account credentials. Once logged in, you should see the `K3s-cluster` resource available for access.
   (If the resource does not appear, request access from the Twingate Admin - Vinura Gallage)
3. After configuring `kubectl` with the shared kubeconfig file, you can access the cluster securely through Twingate. Terraform can also use the same Kubeconfig file if you store it in the `~/.kube/config` location.
   - Test the connection by running: `kubectl get nodes`
